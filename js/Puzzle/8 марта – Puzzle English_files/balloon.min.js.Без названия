var Balloon={$balloon:null,$target:null,showBalloonClass:"show-balloon",addWordClass:".balloon__buttons__add",playClass:".play-sound:not(.play-sound_slowly)",playClassSlow:".play-sound_slowly",rowClass:"balloon-row",rowWordClass:["word-wrapper","corner","puzzle_solved","solved","puzzle__icon","puzzle__item_balloon","single"],rowWordText:[{target:"corner",closest:".puzzle"},{target:"solved",data:"word"},{target:"single",data:"word"},{target:"puzzle__icon",closest:".puzzle__item"}],word:"",parent_word:"",selected_word:"",translation:"",post_type:window.media_type||"",post_id:0,piece_index:0,speakers:{},slow_speakers:{},total_videos:0,phrase_index:0,WordVideo:{},isExpression:false,user_video_id:0,word_phrases:[],isDictionaryPage:false,style:1,STYLE_SMALL:1,STYLE_SELECT:3,STYLE_FULL:4,request:null,updadateConfigOnClose:false,hide_accents:{uk:true,us:false,au:false},playbackRate:1,init:function(){var self=this,$body=$("body");this.setShowBalloonOnClick();$body.on("click",this.addWordClass,function(){self.addWord()});$body.on("click",".balloon__main__text",function(){self.setStyle(self.STYLE_FULL)});$body.on("click",".balloon-open__phrase__footer__show-translate",function(){self.showBalloon(self.$target,false)});$body.on("click",".balloon-vote__element",function(e){if(!$(e.target).is(".balloon__delete-translation"))self.pickContextTranslation($(e.target))});$body.on("click",".balloon__buttons__cancel_style",function(e){var style=self.STYLE_SMALL;self.setStyle(style)});$body.on("click","#balloon .slovo-game__repeat__dictors__list__element",function(){var slug=$(this).data("slug");self.playSpeaker(slug)});$body.on("click","#balloon "+self.playClassSlow,function(){if(!this.emulatedClick)self.updateSpeakersSlowPos()});$body.on("click","#balloon "+self.playClass,function(){Balloon.playbackRate=1;if(!this.emulatedClick)self.updateSpeakersPos()});$(document).on("Sound.audio_playing",function(){$("#balloon").addClass("speaker-playing")});$(document).on("Sound.audio_ended",function(){$("#balloon").removeClass("speaker-playing")});if(user.can_editposts||user.trusted){$body.on("click",".balloon-open__header__vote-words-list__element__clear",function(e){self.clearVotes($(e.target))});$body.on("click",".balloon__admin-action__clear-all",function(e){self.clearVotes($(e.target),true)})}this.WordVideo=new WordVideo;if(!audio.ready)audio.init()},setPostId:function(post_id){var _post_id=parseInt(post_id);if(!isNaN(_post_id)){this.post_id=_post_id}},setShowBalloonOnClick:function(){var $body=$("body"),self=this;$body.on("click","."+this.rowClass,function(event){if($(event.target).parents(".mixed-puzzles-wrap").length)return;self.showBalloon($(event.target))});$body.on("click","."+this.showBalloonClass,function(event){self.showBalloon($(event.currentTarget))})},pickContextTranslation:function($target){if(!user.logged_in){show_sign_popup();return}var $ul=$target.closest("ul"),$li=$target.closest("li"),translation=$target.text(),$data_pointer=null;if($ul.hasClass("popular-list")){$data_pointer=$li}else{$data_pointer=$ul}if($target.data("is_main")){$(".balloon__main__translate").removeClass("balloon__not__main")}else{$(".balloon__main__translate").addClass("balloon__not__main")}var part_of_speech=$data_pointer.data("part_of_speech"),article=$data_pointer.data("article"),word=$data_pointer.data("word");var action=this.$target.data("action")?this.$target.data("action"):this.$target.closest("li.balloon-row").data("action");if(action&&window[action]){var resp=window[action](this,{word:word,part_of_speech:part_of_speech,article:article,translation:translation},this.$target);if(resp===false)return}$(".balloon__main__more").html(article);$(".balloon__main__word").html(word);$(".balloon-main-translation").html(translation);this.setStyle(this.STYLE_SMALL);this.translation=translation;this.selected_word=word;this.part_of_speech=part_of_speech;this.$balloon.find(Balloon.addWordClass).show();this.$balloon.find(".balloon__buttons__add__success").hide();this.saveUserContext({part_of_speech:part_of_speech,word:word,parent_word:this.word});var $vocab_video=this.$balloon.find(".vocab-card__video");$vocab_video.removeClass("is-playing").addClass("loading");this.WordVideo.requestVideos(this.word,this.translation,[],function(response){window.word_videos=response.videos;Balloon.WordVideo.setVideo(0,false);$vocab_video.removeClass("loading")})},setStyle:function(style){this.style=style;this.$balloon.removeAttr("class").addClass("balloon");switch(style){case 1:this.$balloon.addClass("balloon__word__translate balloon__word__translate_vertical");break;case 3:this.$balloon.addClass("balloon-open");break;case 4:this.$balloon.addClass("balloon-open balloon-full");break;default:this.setStyle(this.STYLE_SMALL);break}var $balloon_jbox=$("#balloon-jbox");$balloon_jbox.hide();this.box.setContent(this.$balloon);this.box.position();this.box.position();$balloon_jbox.show();if($("html").hasClass("phone")){$balloon_jbox.css({left:"0px",top:$(window).scrollTop()+"px"})}},showBalloon:function($target,check_parent_expression){var self=this,video_only=false;this.setPostId(0);check_parent_expression=check_parent_expression!==false;this.$target=$target;if($target.closest(".balloon__content__phrase__en").length){if(typeof this.box!=="undefined")this.$target=this.box.target}var doRequest=false,piece_index=0,post_id=0,post_type="",word="",parent_expression="",translation="";if(this.$target.data("show_balloon")===false)return;if(window.media_type==="series"&&window.video_api&&!video_api.paused()&&$target.is(".word-wrapper, expr")){this.playOnClose=true;video_api.pause()}if(window.media_type==="video"&&window.video_html5_api&&$target.closest("#phrases").length==0&&!video_html5_api.paused){this.playOnClose=true;video_html5_api.pause()}if($target.hasClass(this.showBalloonClass)){word=$target.data("word");translation=$target.data("translation");piece_index=$target.data("piece_index")||piece_index;post_id=$target.data("post_id")||this.post_id;post_type=$target.data("post_type")||this.post_type;this.isDictionaryPage=$target.data("dictionary_page");doRequest=true;video_only=$target.data("video_only")?true:video_only}var hasClass=false,targetClass="";for(var i=0;i<this.rowWordClass.length;i++){if($target.hasClass(this.rowWordClass[i])||$target.parent().hasClass(this.rowWordClass[i])||$target.is("expr")){hasClass=true;targetClass=this.rowWordClass[i];break}}var $closest=$target.closest("."+this.rowClass);if($closest.length&&hasClass&&!$target.hasClass("no-balloon_js")){for(var exc=0;exc<self.rowWordText.length;exc++){if(targetClass==self.rowWordText[exc].target){if(typeof self.rowWordText[exc].data!=="undefined"){word=$target.data(self.rowWordText[exc].data)}else if(typeof self.rowWordText[exc].closest!=="undefined"){var word_element=$target.closest(self.rowWordText[exc].closest);if(word_element.find(".word").length)word_element=word_element.find(".word");word=word_element.text()}}}if(word=="")word=$target.text();piece_index=$closest.attr("data-piece_index")||piece_index;post_id=$closest.attr("data-post_id")||post_id;post_type=$closest.attr("data-post_type")||this.post_type;this.isDictionaryPage=$closest.data("dictionary_page");doRequest=true}if(word=="")doRequest=false;var $dictionary_balloon=$("#dictionary_balloon");if($dictionary_balloon.length!==0){$dictionary_balloon.data("word",word);$dictionary_balloon.data("translation",translation)}post_id=$target.parent().data("post_id")?$target.parent().data("post_id"):post_id;piece_index=$target.parent().data("piece_index")?$target.parent().data("piece_index"):piece_index;post_id=$target.data("post_id")?$target.data("post_id"):post_id;piece_index=$target.data("piece_index")?$target.data("piece_index"):piece_index;post_id=post_id||window["post_id"];post_type=post_type||this.post_type;this.setPostId(post_id);var $parent=$target.parent();var expression_form="";var $expr=$parent.is("expr, .expression")?$parent:$target.is("expr, .expression")?$target:[];if(check_parent_expression&&$expr.length){parent_expression="";if(!$expr.attr("data-base")){$($expr.html()).each(function($word){parent_expression+=$(this).text()+" "})}else{parent_expression=$expr.attr("data-base")}parent_expression=parent_expression.trim();if($expr.attr("data-base")){expression_form=$expr.text()}}var data={ajax_action:"ajax_balloon_Show",post_id:post_id,piece_index:piece_index,translation:translation,word:word,parent_expression:parent_expression,expression_form:expression_form};var callback=function(response){if(typeof response!=="object"||response.length===0){self.box&&self.box.destroy();return}self.$balloon=$(response["html"]);self.speakers=response["word_speakers"];self.slow_speakers=response["word_speakers_slow"];self.hide_accents=response["hide_accents"];window.word_videos=response.word_videos;self.piece_index=self.$balloon.data("piece_index");self.word=self.$balloon.data("word");self.part_of_speech=self.$balloon.data("part_of_speech");self.word_part_of_speech=self.$balloon.data("word_part_of_speech")||"";self.parent_word=self.$balloon.data("parent_word");self.selected_word=self.$balloon.data("selected_word");self.translation=self.$balloon.data("translation");self.total_videos=self.$balloon.data("total_videos");self.isExpression=response.Word.is_expression;self.user_video_id=response.Word.user_video_id;self.word_phrases=response.word_phrases;var votes_exists=response.Word.vote_exists;var style=self.STYLE_SMALL;if(response.Word.exists&&!votes_exists){style=self.STYLE_SELECT}self.WordVideo.init({video:self.$balloon.find("#word_video").get(0),set_video:Object.keys(response.word_videos).length>0,is_single:true});var word_videos_length=Object.keys(window.word_videos).length;if(typeof window.word_videos!="undefined"&&word_videos_length===0){self.$balloon.find(".balloon__video__examples .balloon__content").hide()}else if(word_videos_length===1){self.WordVideo.$nextButton.hide()}self.setStyle(style);if($("html").hasClass("phone")){self.$balloon.css({width:$(window).width()+"px"});$("#balloon-jbox").css({left:"0px",top:$(window).scrollTop()+"px"});$(".jBox-pointer").hide()}var $play_button=self.$balloon.find(self.playClass);$play_button[0].emulatedClick=1;$play_button.click();$play_button[0].emulatedClick=0;if(video_only){self.$balloon.find(".balloon__dict").hide();self.$balloon.find(".balloon__video__examples-wrapper").show();self.$balloon.find(".balloon__phrases__examples-wrapper").show();self.box.position()}if(self.$balloon.find(".slovo-game__repeat__dictors__list__element").length==1&&self.part_of_speech!="expression"){self.$balloon.find(".slovo-game__repeat__dictors__list__wrapper").show()}if(self.isDictionaryPage){self.$balloon.find(".balloon-open__header").hide()}self.request=null;self.$balloon.find(".balloon__content__phrase__source__icon").on("click",function(e){$(this).parents(".balloon__content__phrase").toggleClass("is-source")});if(user.can_editposts||user.trusted){self.$balloon.find(".balloon-open__content__list__element").sortable({connectWith:".balloon-open__content__list__element",receive:balloon_sortableReceiveCallback}).disableSelection()}if($("#balloon__multitran_expressions").is(":visible")){$("#balloon-jbox").addClass("balloon__page_multitran_expressions")}self.phrase_index=0;self.move_phrase(1)};$("#balloon").remove();if(doRequest){if(this.request){this.request.abort();this.request=null}this.box&&this.box.destroy();var $jbox_target=null;if(self.$target.data("target"))$jbox_target=$(self.$target.data("target"));else $jbox_target=self.$target;var balloon_position={},_adjustPosition;if($target.parents("#vid-subslist-sub-current").parents(".video-fullscreen").length!==0||$target.parents("#vid-subs").parents(".video-fullscreen").length!==0||$target.parents("#vid-subs").parents(".series-light__popup").length!==0||$target.parents(".b-episode_media_container").parents(".pe-movies__page").length!==0&&$target.parents("#vid-pause-mode").length==0){_adjustPosition=false;balloon_position={x:"center",y:"top"}}else{_adjustPosition=true;balloon_position={x:"center",y:"bottom"}}this.box=new jBox("Tooltip",{id:"balloon-jbox",target:$jbox_target,theme:"TooltipBorder",width:"auto",height:"auto",pointTo:"target",adjustPosition:_adjustPosition,adjustTracker:false,adjustDistance:{top:55,right:5,bottom:5,left:5},closeOnClick:"body",closeOnEsc:true,zIndex:500,position:balloon_position,outside:"y",content:'<img class="balloon_preloader" src="/wp-content/themes/english/admin/images/preloader-big.gif">',animation:false,onInit:function(){this.options.height=$("#balloon").height()},onClose:function(){if(self.updadateConfigOnClose)self.updateCustomConfig();var $balloon_jbox=$("#balloon-jbox");$balloon_jbox.hide()},onCloseComplete:function(){this.destroy();Balloon.WordVideo.video_id=0;if(typeof Balloon.WordVideo.video_api!=="undefined"&&Balloon.WordVideo.video_api!==null){Balloon.WordVideo.video_api.dispose()}Balloon.WordVideo.video_api=null;Balloon.box=null;Balloon.$balloon=null;Sound.clearCurrentList();var in_sub_titles=$target.closest("#vid-subs").length;if(in_sub_titles){window.video_api&&video_api.play()}else if((window.media_type==="series"||window.media_type==="video")&&self.playOnClose){window.video_api&&video_api.play();self.playOnClose=false}}});this.box.open();this.request=$.ajax({url:window["HOME"],success:callback,data:data,type:"post"})}},close:function(){this.box&&this.box.close()},addWord:function(){var self=this,video_post_id=0,video_piece_index=0;if(!user.logged_in){show_sign_popup();return}if(typeof word_videos[Balloon.WordVideo.index]!=="undefined"){video_post_id=word_videos[Balloon.WordVideo.index].post_id;video_piece_index=word_videos[Balloon.WordVideo.index].piece_index}var data={ajax_action:"ajax_dictionary_addWord",post_id:this.post_type=="dictionary"?video_post_id:this.post_id,piece_index:this.post_type=="dictionary"?video_piece_index:this.piece_index,word:this.selected_word,translation:this.translation,part_of_speech:this.part_of_speech,video_id:this.WordVideo.video_id,post_type:this.post_type,is_dictionary_page:this.isDictionaryPage};var callback=function(response){self.$balloon.find(Balloon.addWordClass).hide();self.$balloon.find(".balloon__buttons__add__success").addClass("is-visible").show();self.$balloon.find(".delete").data("word_id",response.user_word_id);if(response["word_html"]){$(".append-word-to").prepend(response["word_html"]);if($(".append-word-to div.box-to-delete").length>=36){$(".append-word-to div.box-to-delete:last").remove()}}changeDictWordsCount()};$.post(window["HOME"]+document.location.search,data,callback,"json")},playSpeaker:function(speaker){var index=speaker;if(isNaN(speaker)){index=Sound.getIndexBySpeaker(speaker)}if(index!=-1){var $items=$("#balloon").find(".slovo-game__repeat__dictors__list__element:not(.hidden)");var $currentItem=$items.filter("[data-slug="+Sound.currentList[index].slug+"]");$items.removeClass("is-active");$currentItem.addClass("is-active");Sound.play(this.selected_word.toLocaleLowerCase(),speaker);if(speaker.indexOf("slow")>=0){this.updateSpeakersSlowPos()}else{this.updateSpeakersPos()}}},updateSpeakersSlowPos:function(){if(Balloon.part_of_speech=="expression"&&$("#balloon .slovo-game__repeat__dictors__list__wrapper_slow .slovo-game__repeat__dictors__list__element").length==1)return;$("#balloon .slovo-game__repeat__dictors__list__wrapper").hide();var $wrap=$("#balloon .slovo-game__repeat__dictors__list__wrapper_slow").show();if(!$wrap.length)return;var $ul=$wrap.children();var $currentItem=$ul.children(".is-active");var ww=$wrap.width();var uw=$ul.width();var iw=$currentItem.width();var current_item_pos=$currentItem.position().left;var pos=0;if(current_item_pos>ww/2){pos=-(current_item_pos-ww/2)-iw/2}if(pos<-uw+ww){pos=-uw+ww}if(pos>0)pos=0;$ul.css("left",pos)},updateSpeakersPos:function(){this.$balloon.find(".slovo-game__repeat__dictors__list__wrapper_slow").hide();var $wrap=this.$balloon.find(".slovo-game__repeat__dictors__list__wrapper");$wrap.show();if(!$wrap.length)return;var $ul=$wrap.children();var $currentItem=$ul.children(".is-active");var ww=$wrap.width();var uw=$ul.width();var iw=$currentItem.width();var current_item_pos=$currentItem.position().left;var pos=0;if(current_item_pos>ww/2){pos=-(current_item_pos-ww/2)-iw/2}if(pos<-uw+ww){pos=-uw+ww}if(pos>0)pos=0;$ul.css("left",pos)},saveUserContext:function(options){var data={ajax_action:"ajax_balloon_saveUserContext",post_id:this.post_id,piece_index:this.piece_index,word:this.selected_word,part_of_speech:this.part_of_speech,parent_word:this.parent_word,translation:this.translation,video_id:this.WordVideo.video_id};data=$.extend({},data,options||{});var callback=function(res){$(document).trigger("saveUserContext.balloon",[data,res])};$.post(window["HOME"],data,callback,"json")},clearVotes:function($target,all){if(!$target.data("confirmed")){$target.data("confirmed",true);$target.html("Подтвердить");return}var data={},callback={};if(typeof all==="undefined"){data={ajax_action:"ajax_balloon_clearVotes",post_id:this.post_id,piece_index:this.piece_index,word:$target.closest("ul.balloon-open__content__list").data("word")||$target.closest("li").data("word")||this.word,part_of_speech:$target.data("part_of_speech"),translation:$target.data("translation")};callback=function(response){if(!response.error){$target.closest("li").remove();$('.balloon-vote__element:contains("'+$target.data("translation")+'")').next().remove()}}}else{data={ajax_action:"ajax_balloon_clearVotes",post_id:this.post_id,piece_index:this.piece_index,word:$target.closest("ul.balloon-open__content__list").data("word")||$target.closest("li").data("word")||this.word,all:1};callback=function(response){$(".balloon-open__header__vote-words-list .popular-list").remove();$(".balloon-open__header__vote-words-list__element__votes").remove()}}$.post(window["HOME"],data,callback,"json")},updateCustomConfig:function(){var items={};$.each(this.$balloon.find(".balloon-conf_checkbox"),function(){items[$(this).data("item")]=$(this).find(".check-box__target").hasClass("check-box__target_checked")?1:0});$.post("/",{ajax_action:"ajax_balloon_updateCustomConfig",items:items},null,"json")},move_phrase:function(i){if(this.word_phrases.length===0)return;$(".balloon__phrase-text_en").html(this.word_phrases[this.phrase_index].phrase_en);$(".balloon__phrase-text_ru").html(this.word_phrases[this.phrase_index].phrase_ru);this.phrase_index+=i;if(this.phrase_index>=this.word_phrases.length-1){Balloon.$balloon.find(".wordPhraseNext").hide()}else{Balloon.$balloon.find(".wordPhraseNext").show()}if(this.phrase_index<=0){Balloon.$balloon.find(".wordPhrasePrev").hide()}else{Balloon.$balloon.find(".wordPhrasePrev").show()}}};function WordVideo(){this.word_id=null;this.user_word_id=null;this.card={};this.$box={};this.$card=null;this.$playButton=null;this.$card_video=null;this.$saveChoice=null;this.$phrase_en=null;this.$card_phrase_en=null;this.$card_phrase_ru=null;this.$nextButton=null;this.$prevButton=null;this.initialized=false;this.video=null;this.current_word_id=0;this.video_id=0;this.index=0;this.is_single=true;this.is_video_set=false;this.nextButton=null;this.prevButton=null;this.playButton=null;this.phrase_ru=null;this.phrase_en=null;this.confirmButton=null;this.request_object=null;this.options={};this.init=function(_options){var defaults={video:null,is_single:true,set_video:false,$box:Balloon.$balloon,nextButton:".wordVideoNext",prevButton:".wordVideoPrev",playButton:".wordVideoPlay",phraseRu:".wordVideoPhraseRu",phraseEn:".wordVideoPhraseEn",saveButton:".wordVideoSaveChoice",phrase_en:".balloon__content__phrase__en",phrase_ru:".balloon__content__phrase__ru",request_videos:true,vu_key:"user_word_id"};this.options=$.extend({},defaults,_options||{});this.$box=this.options.$box;this.is_single=!!this.options.is_single;if(this.is_single){this.video=this.options.video;if(this.options.set_video){this.video_api=videojs(this.options.video)}this.$card_video=Balloon.$balloon.find(".vocab-card__video");this.$playButton=Balloon.$balloon.find(".wordVideoPlayButton");this.$saveChoice=Balloon.$balloon.find(this.options.saveButton);this.$phrase_en=Balloon.$balloon.find(this.options.phrase_en);this.$phrase_ru=Balloon.$balloon.find(this.options.phrase_ru);this.$nextButton=Balloon.$balloon.find(this.options.nextButton);this.$prevButton=Balloon.$balloon.find(this.options.prevButton)}if(this.is_single||this.options.set_video){this.$phrase_en=this.$box.find(this.options.phrase_en);this.$phrase_ru=this.$box.find(this.options.phrase_ru)}if(!this.initialized){this.initialized=true}if(this.options.set_video){if(!this.is_single)this.updateContext($("#word-video-target"));this.is_video_set=this.setVideo(0,false)}if(this.options.disable_buttons){this.$box&&this.$box.find(this.options.prevButton).addClass(this.options.disable_buttons)}else{this.$box&&this.$box.find(this.options.prevButton).hide()}};this.getVideoObject=function(){if(this.is_single){return this.video_api}else{var video_id="word-video"+this[this.options.vu_key];var $tmp=$("#"+video_id+"-tmp");var side=$tmp.parents(".card-front").length?"front":"back";var autoplay=$("html").hasClass("safari");$tmp.replaceWith('<video class="wordVideoPlay card-video '+side+' video-js" id="'+video_id+'" preload="none" '+(autoplay?" autoplay ":"")+"></video>");if(!window[video_id]||!window[video_id].tech){window[video_id]=videojs(video_id);window[video_id].src($tmp.data("src"))}return window[video_id]}};this.updateContext=function($target){var $card=$target.closest(".card");this.word_id=$card.data("word_id");this.user_word_id=$card.data("user_word_id");this.$playButton=$card.find(".wordVideoPlayButton");this.$card_video=$card.find(".vocab-card__video");this._pauseVideo();if(this.current_word_id===this.word_id)return;this.current_word_id=this.word_id;this.$card=$card;this.index=$card.data("video_index");this.$saveChoice=$card.find(this.options.saveButton);this.$phrase_en=$card.find(this.options.phrase_en);this.$card_phrase_en=$card.find(".vocab-card__phrase-eng");this.$card_phrase_ru=$card.find(".vocab-card__phrase-rus");this.$nextButton=$card.find(this.options.nextButton);this.$prevButton=$card.find(this.options.prevButton);this.card.word=$card.data("word");this.card.translation=$card.data("translation");this.card.post_id=$card.data("post_id");this.card.piece_index=$card.data("piece_index");this.card.video_post_id=$card.data("video_post_id");this.card.video_piece_index=$card.data("video_piece_index");this.card.video_weight=$card.data("video_weight");this.card.user_word_id=$card.data("user_word_id");this.card.record_id=$card.data("record_id");this.card.video_id=$card.data("video_id");this.card.phrase_en=$card.data("phrase_en");this.card.phrase_ru=$card.data("phrase_ru")};this.nextVideo=function(autoplay){autoplay=typeof autoplay!=="undefined";this.setVideo(this.index+1,autoplay)};this.prevVideo=function(autoplay){autoplay=typeof autoplay!=="undefined";this.setVideo(this.index-1,autoplay)};this.setVideo=function(index,autoplay){var self=this;this.video_id=0;if(typeof index==="undefined")index=this.index;if(typeof autoplay==="undefined")autoplay=true;var video=this.getVideoObject();var video_data={};var $vocab_video=null;if(this.is_single){video_data=window.word_videos;if(0&&index+5>=video_data.length&&video_data.length<Balloon.total_videos){$vocab_video=Balloon.$balloon.find(".vocab-card__video");$vocab_video.removeClass("is-playing").addClass("loading");var exclude_ids=[];for(var i=0;i<video_data.length;i++){exclude_ids.push(video_data[i].id)}Balloon.WordVideo.requestVideos(Balloon.word,Balloon.translation,exclude_ids,function(response){window.word_videos=window.word_videos.concat(response.videos);if(response.videos.length>0){Balloon.WordVideo.setVideo(index,false)}$vocab_video.removeClass("loading")});return}}else{if(typeof window.word_videos[this.word_id]=="undefined"&&this.options.request_videos){$vocab_video=this.$card.find(".vocab-card__video");$vocab_video.removeClass("is-playing").addClass("loading");this.requestVideos(self.card.word,this.card.translation,[self.card.video_id],function(response){window.word_videos[self.word_id]=response.videos;window.word_videos[self.word_id].unshift({id:self.card.video_id,phrase_en:self.card.phrase_en,phrase_ru:self.card.phrase_ru,post_id:self.card.video_post_id,piece_index:self.card.video_piece_index,weight:self.card.video_weight});$vocab_video.removeClass("loading");self.setVideo(index,autoplay)});return}else{video_data=window.word_videos[this.word_id]}}if(typeof window.word_videos=="undefined"||typeof video_data=="undefined"||isEmpty(video_data[0]))return false;if(video_data.length!==0){if(typeof video==="undefined"||video===null){this.video_api=videojs(this.options.video);video=this.getVideoObject()}}if(index+1>video_data.length-1){if(this.options.disable_buttons){this.$nextButton.addClass(this.options.disable_buttons);this.$prevButton.removeClass(this.options.disable_buttons)}else{this.$nextButton.hide();this.$prevButton.show()}}else{if(this.options.disable_buttons){this.$nextButton.removeClass(this.options.disable_buttons)}else{this.$nextButton.show()}}if(index-1<0){if(this.options.disable_buttons){this.$nextButton.removeClass(this.options.disable_buttons);this.$prevButton.addClass(this.options.disable_buttons)}else{this.$nextButton.show();this.$prevButton.hide()}}else{if(this.options.disable_buttons){this.$prevButton.removeClass(this.options.disable_buttons)}else{this.$prevButton.show()}}if(this.is_single){if(video_data.length<=0){Balloon.$balloon.find(".vocab-card__video").hide();return false}else{Balloon.$balloon.find(".vocab-card__video").show()}}if(index<0||index>video_data.length-1)return false;this.index=index;this.video_id=parseInt(video_data[this.index].id);if(!this.is_single){this.$card.data("video_index",index)}this.updateVotesCount(video_data[this.index].weight);var post_id=video_data[this.index].post_id;var piece_index=video_data[this.index].piece_index;if(typeof post_id==="undefined"||typeof piece_index==="undefined")return false;if((this.is_single||this.options.set_video)&&video_data[this.index].phrase_en){this.$phrase_en.html(video_data[this.index].phrase_en).show();this.$phrase_ru.html(video_data[this.index].phrase_ru);this.$box.find(".balloon__content__phrase__source__text").html(video_data[this.index].post_title);this.$box.find(".balloon__content__phrase__source__text").attr("href",video_data[this.index]["post_url"]);if(this.is_single){var $context_notice=this.$box.find(".balloon__context__notice");if(video_data[this.index].context&&!video_data[this.index].synonym){$context_notice.hide()}else{var $items=Balloon.$balloon.find(".balloon__context__notice__items");if(typeof video_data[this.index].context_translation!="undefined"&&video_data[this.index].context_translation.length>0){$items.show();$items.find("strong").html(Balloon.word);$items.find("small").html(video_data[this.index].context_translation)}else{$items.hide()}if(video_data[this.index].context&&video_data[this.index].synonym){$context_notice.addClass("synonym")}else{$context_notice.removeClass("synonym")}$context_notice.show()}}}else if(video_data[this.index].phrase_en&&!this.options.set_video){this.$card_phrase_en.html(video_data[this.index].phrase_en);this.$card_phrase_ru.html(video_data[this.index].phrase_ru);this.$card.find(".balloon__content__phrase__source__text").html(video_data[this.index].post_title);this.$card.find(".balloon__content__phrase__source__text").attr("href",video_data[this.index]["post_url"]);this.$phrase_en.hide()}var src=window["STATIC_HOME"]+"/video_pieces/mp4/"+post_id+"/"+piece_index+"_360px.mp4";this._pauseVideo();var poster=window["STATIC_HOME"]+"/video_pieces/mp4/"+post_id+"/"+piece_index+".jpg";if(this.is_single){video.poster=poster}else{$("#word-video"+this[this.options.vu_key]).find("video").get(0).poster=poster}video.src(src);if(autoplay)this.play();this.options.request_videos=true;return true};this.updateVotesCount=function(votes_count){var $wordVideoSaveChoice_votes=this.$saveChoice.find(".wordVideoSaveChoice_votes");if($wordVideoSaveChoice_votes.data("selected_video")){if($wordVideoSaveChoice_votes.data("selected_video")!=this.video_id){this.$saveChoice.find(".wordVideoSaveChoice_text").html("Выбрать этот пример");this.$card.find(".balloon__content__phrase__check__icon").hide()}else{this.$saveChoice.find(".wordVideoSaveChoice_text").html("Пример выбран");this.$card.find(".balloon__content__phrase__check__icon").show()}}};this.play=function(){var video=this.getVideoObject(),self=this;video.on("play",function(){self.$playButton.hide();self.$card_video.addClass("is-playing");video.off("play",this)});video.on("ended",function(){self._pauseVideo();video.off("ended",this)});video.ready(function(){video.play()})};this._pauseVideo=function(){var video=this.getVideoObject();video&&video.pause();this.$playButton&&this.$playButton.show();this.$card_video?this.$card_video.removeClass("is-playing"):$(".vocab-card__video").removeClass("is-playing")};this.requestVideos=function(word,translation,exclude_ids,callback){var self=this;var data={ajax_action:"ajax_cards_getWordVideos",word:word,translation:translation,exclude_ids:exclude_ids};var success_callback=function(_response){self.request_object=null;callback&&callback(_response)};if(this.request_object!==null){this.request_object.abort()}this.request_object=$.ajax({url:window["HOME"],success:success_callback,data:data,type:"post"})};this.saveUserVideo=function(){var data={ajax_action:"ajax_cards_saveUserVideo",user_word_id:this.card.user_word_id,video_id:this.video_id,word:this.card.word,post_id:this.card.post_id,piece_index:this.card.piece_index,record_id:this.card.record_id};$.post("/",data,null,"json")}}var Sound={options:{},currentList:[],currentWord:"",currentSpeakers:"",index:0,$element:{},init:function(_options){var self=this;var defaults={playButton:".play-sound",playButtonSlow:".play-sound_slowly"};this.options=$.extend({},defaults,_options||{});var body=$("body");body.on("click",this.options.playButton+", "+this.options.playButtonSlow,function(e){var $sound=$(e.currentTarget);self.$element=$sound;if($(this).hasClass("play-sound_slowly")){Balloon.playbackRate=.55}else{Balloon.playbackRate=1}if($sound.data("audio")){self.playSoundUrl($sound.data("audio"))}else{var speakers_string=$sound.data("speakers");if(!speakers_string){speakers_string=$(this).parent().find(".play-sound:not(.play-sound_slowly)").data("speakers")}else{Balloon.playbackRate=1}if(speakers_string===null)return;var speakers=speakers_string.length>0?speakers_string.split(","):[];var word=$sound.data("word");var accent_parts,accent;if(self.currentList.length===0||self.currentWord!=word||self.currentSpeakers!=speakers_string){Sound.clearCurrentList();for(var i=0;i<speakers.length;i++){accent_parts=speakers[i].split("_");accent=accent_parts[accent_parts.length-1].toLowerCase();self.currentList.push({slug:speakers[i],accent:accent})}self.currentWord=word;self.currentSpeakers=speakers_string}self.playWord(word)}})},play:function(word,speakerSlug,path){path=typeof path==="undefined"||!path?"words":path;if(speakerSlug!=="vocalware_hugh_UK")word=word.replaceAll(/\s+/,"-");audio.obj.src=window["STATIC_HOME"]+"/"+path+"/"+speakerSlug+"/"+word+".mp3";audio.obj.playbackRate=Balloon.playbackRate;audio.obj.play();$(document).trigger("Sound.audio_playing");audio.addEventListener("error",function(e){audio.removeEventListener("error");if(e.target.error!==null){$(document).trigger("Sound.audio_error")}});audio.addEventListener("ended",function(){audio.removeEventListener("ended");$(document).trigger("Sound.audio_ended")});if(Balloon.$balloon!==null){Balloon.$balloon.find(".slovo-game__repeat__dictors__list__element").removeClass("is-active").filter("[data-slug="+speakerSlug+"]").addClass("is-active")}},playWord:function(word){var hidden_accents=[];if(this.currentList.length===0||!word)return;var path=this.$element.data("path");for(var k in Balloon.hide_accents){if(Balloon.hide_accents.hasOwnProperty(k)){
if(Balloon.hide_accents[k])hidden_accents.push(k)}}var i=this.index+1<this.currentList.length?this.index+1:0;this.index=Math.min(this.index,this.currentList.length-1);while(i!==this.index){if($.inArray(this.currentList[i].accent,hidden_accents)===-1){this.index=i;break}i++;if(i===this.currentList.length)i=0}if(this.currentList[this.index].slug!=="vocalware_hugh_UK")word=word.replaceAll("\\s+","-");this.play(word,this.currentList[this.index].slug,path)},playSoundUrl:function(url){if(!url)return;audio.obj.src=url;audio.obj.playbackRate=Balloon.playbackRate;audio.obj.play();audio.obj.addEventListener("ended",function(){audio.removeEventListener("ended")})},getIndexBySpeaker:function(speaker){for(var i=0;i<this.currentList.length;i++){if(this.currentList[i].slug===speaker){return i}}return-1},clearCurrentList:function(){this.currentList=[]}};function isSingle($target){return $target.closest(".vocab-card__video").hasClass("single")}typeof window.word_videos==="undefined"?window.word_videos={}:window.word_videos;$(document).on("ready",function(){var $body=$("body");Sound.init();Balloon.init();$body.on("click",".balloon__settings-hint_js_click",function(){$(this).css("display","none");return false});$body.on("click",".balloon__settings-hint-target_js_click",function(){$(this).parents(".balloon__settings-hint").css("display","none");$(".balloon__buttons__settings").trigger("click")});$body.on("click",".balloon__buttons__settings_js_click",function(){if(!user.logged_in){show_sign_popup();return}Balloon.updadateConfigOnClose=true;var $settings=$(this).parents(".balloon__general").siblings(".balloon__settings");var $balloon=$(this).parents(".balloon__general");if($(this).hasClass("is-active")){$(this).removeClass("is-active");$settings.css("display","none");$settings.css("top","")}else{$(this).addClass("is-active");$settings.css("display","");var windowHeight=document.documentElement.clientHeight;var offsetTop=$settings.offset().top-$(document).scrollTop();var bottomOffset=windowHeight-offsetTop;var settingsHeight=$settings.outerHeight();var shiftValue=settingsHeight-$balloon.outerHeight();var offsetLeft=$settings.offset().left;if(bottomOffset<settingsHeight){$settings.css("top","-"+shiftValue+"px")}if(offsetLeft<0){$settings.css("left","100%")}else{$settings.css("left","")}}});$body.on("click",".balloon__settings-close",function(){var $settingsBtn=$(this).parents(".balloon__settings").siblings(".balloon__general").find(".balloon__buttons__settings_js_click");$(this).parents(".balloon__settings").css("display","none");if($settingsBtn.hasClass("is-active")){$settingsBtn.removeClass("is-active")}});$body.on("click",".wordVideoPlay",function(e){if(isSingle($(e.target))){Balloon.WordVideo.play()}else{CardWordVideo.updateContext($(e.target));CardWordVideo.play()}});$body.on("click",".wordVideoPrev",function(e){if(isSingle($(e.currentTarget))){Balloon.WordVideo.prevVideo()}else{CardWordVideo.updateContext($(e.currentTarget));CardWordVideo.prevVideo(true)}});$body.on("click",".wordVideoNext",function(e){if(isSingle($(e.currentTarget))){Balloon.WordVideo.nextVideo()}else{CardWordVideo.updateContext($(e.currentTarget));CardWordVideo.nextVideo(true)}});$body.on("click",".wordVideoSaveChoice",function(e){if(!user.logged_in){show_sign_popup();return}var obj={},is_single=isSingle($(e.target));if(is_single){if(Balloon.user_video_id===Balloon.WordVideo.video_id)return;Balloon.saveUserContext({video_id:Balloon.WordVideo.video_id});Balloon.user_video_id=Balloon.WordVideo.video_id;obj=Balloon.WordVideo}else{CardWordVideo.updateContext($(e.target));if(CardWordVideo.$saveChoice.find(".wordVideoSaveChoice_votes").data("selected_video")==CardWordVideo.video_id)return;CardWordVideo.saveUserVideo();obj=CardWordVideo}var $wordVideoSaveChoice_votes=obj.$saveChoice.find(".wordVideoSaveChoice_votes");var selected_video=$wordVideoSaveChoice_votes.data("selected_video"),selected_index=$wordVideoSaveChoice_votes.data("selected_index");if(typeof selected_video!="undefined"&&obj.video_id!=selected_video){if(is_single){window.word_videos[selected_index].weight--;window.word_videos[obj.index].weight++}else{window.word_videos[obj.word_id][selected_index].weight--;window.word_videos[obj.word_id][obj.index].weight++}}obj.updateVotesCount();obj.$saveChoice.find(".wordVideoSaveChoice_text").html("Пример выбран");obj.$saveChoice.find(".wordVideoSaveChoice_votes").data("selected_video",obj.video_id).data("selected_index",obj.index);obj.$card.find(".balloon__content__phrase__check__icon").show()});$body.on("click",".delete",function(e){if(parseInt(user.id)===0)return;var callback=null;var $box=$(e.currentTarget).closest(".box-to-delete");if($box.length>0){callback=function(){$box.remove()}}else{callback=function(){var $balloon=$(e.currentTarget).closest("#balloon");$balloon.find(".balloon__buttons__add__success").removeClass("is-visible");$balloon.find(Balloon.addWordClass).show()}}var data={ajax_action:"ajax_cards_deleteUserWord",id:$(e.currentTarget).data("id"),is_phrase:$(e.currentTarget).closest(".dict-info").data("is_phrase")};$.post("/",data,function(){changeDictWordsCount(-1)});callback();$box.remove()});$body.on("click",".add-single-word",function(e){var $target=$(e.currentTarget);var callback=function(){$target.removeClass("add-single-word").addClass("single-word-added");$target.html("Добавлено")};addWordToDictionary($target,callback)});$body.on("click",".balloon-conf_checkbox",function(e){var $balloon=$("body").find("#balloon"),item=$(this).data("item"),on=$(this).find(".check-box__target").hasClass("check-box__target_checked");switch(item){case"speaker_regular_btn":if(on){$balloon.find(".play-sound").show()}else{$balloon.find(".play-sound").hide()}break;case"speaker_slow_btn":if(on){Balloon.$balloon.find(".play-sound_slowly").show()}else{Balloon.$balloon.find(".play-sound_slowly").hide()}break;case"transcription_us_show":if(on){$balloon.find(".balloon__transcriptions > .accent-us").show()}else{$balloon.find(".balloon__transcriptions > .accent-us").hide()}break;case"transcription_uk_show":if(on){$balloon.find(".balloon__transcriptions > .accent-uk").show()}else{$balloon.find(".balloon__transcriptions > .accent-uk").hide()}break;case"accent_uk":var $speakers_uk=$balloon.find(".slovo-game__repeat__dictors__list").find("li[data-accent=uk]");if(on){$speakers_uk.show();Balloon.hide_accents["uk"]=false}else{$speakers_uk.hide();Balloon.hide_accents["uk"]=true}break;case"accent_us":var $speakers_us=$balloon.find(".slovo-game__repeat__dictors__list").find("li[data-accent=us]");if(on){$speakers_us.show();Balloon.hide_accents["us"]=false}else{$speakers_us.hide();Balloon.hide_accents["us"]=true}break;case"accent_au":var $speakers_au=$balloon.find(".slovo-game__repeat__dictors__list").find("li[data-accent=au]");if(on){$speakers_au.show();Balloon.hide_accents["au"]=false}else{$speakers_au.hide();Balloon.hide_accents["au"]=true}break;case"example_videos":if(on){$balloon.find(".balloon__video__examples-wrapper").slideDown(300)}else{$balloon.find(".balloon__video__examples-wrapper").slideUp(300)}$balloon.find(".balloon__arrow").toggleClass("balloon__arrow-down");break;case"example_phrases":if(on){$balloon.find(".balloon__phrases__examples-wrapper").slideDown(300)}else{$balloon.find(".balloon__phrases__examples-wrapper").slideUp(300)}$balloon.find(".balloon__arrow").toggleClass("balloon__arrow-down");break;case"example_forms":if(on){$balloon.find(".balloon__forms__examples-wrapper").slideDown(300)}else{$balloon.find(".balloon__forms__examples-wrapper").slideUp(300)}$balloon.find(".balloon__arrow").toggleClass("balloon__arrow-down");break}switch(item){case"accent_uk":case"accent_us":case"accent_au":if($(".balloon__settings-accents").find(".check-box__target_checked").length===0){$(".slovo-game__repeat__dictors__list__wrapper").hide();$.each($(".balloon__settings-speakers").find(".check-box__target_checked").closest(".j-checkbox-line"),function(){$(this).find("input").removeAttr("checked");$(this).find(".check-box__target").removeClass("check-box__target_checked")});Balloon.$balloon.find(".play-sound").hide();Balloon.$balloon.find(".play-sound_slowly").hide()}else{$(".slovo-game__repeat__dictors__list__wrapper").show();if($(".balloon__settings-speakers").find(".check-box__target_checked").length===0){$(".balloon__settings-speakers").find(".j-checkbox-line[data-item=speaker_regular_btn]").click()}}break}switch(item){case"speaker_regular_btn":case"speaker_slow_btn":if($(".balloon__settings-speakers").find(".check-box__target_checked").length&&$(".balloon__settings-accents").find(".check-box__target_checked").length===0){$(".balloon__settings-accents").find(".j-checkbox-line[data-item=accent_uk]").click()}break}});$body.on("click",".wordPhrasePrev, .wordPhraseNext",function(e){if($(this).hasClass("wordPhraseNext")){Balloon.move_phrase(1)}else{Balloon.move_phrase(-1)}})});function addWordToDictionary($target,callback){var word=$target.data("word");word=word.replace(/^(a|an|the)\s+/i,"");var data={ajax_action:"ajax_dictionary_addWord",post_id:$target.data("post_id")||window.post_id,piece_index:$target.data("piece_index"),word:word,translation:$target.data("translation"),part_of_speech:$target.data("part_of_speech"),video_id:0,post_type:$target.data("post_type")||"",is_dictionary_page:false};var responseCallback=function(response){callback&&callback()};$.post(window["HOME"]+document.location.search,data,responseCallback,"json")}function addPhraseToDictionary(post_id,piece_index,self){if(post_id===0){post_id=$(self).closest(".b-phrases_block__phrases_actions").data("post_id");piece_index=$(self).closest(".b-phrases_block__phrases_actions").data("piece_index")}$(self).attr("onclick","");$(self).find("span").text("Добавлено");$.post("/",{ajax_action:"ajax_dictionary_addPhrase",post_id:post_id,piece_index:piece_index})}function changeDictWordsCount(count){var $dc=$(".dictionary_count"),new_count=$dc.data("count");count=typeof count==="undefined"?1:parseInt(count);if(new_count<=0)return;new_count+=count;$dc.data("count",new_count);$dc.html(new_count+" "+plural_ru(new_count,["слово","слова","слов"]))}function balloonChangeSynonymGroup(word_id,words,new_group){$.post("/",{ajax_action:"ajax_balloon_changeSynonymGroup",word_id:word_id,words:words,group:new_group},null,"json")}